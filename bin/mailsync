#!/usr/bin/env bash
mbconf=~/.config/mbsync/tu-dresden

pass_re="PassCmd \+\"(.*)\""
passcmd_line=$(grep ^PassCmd $mbconf)
nlines=$(wc -l <(echo "$passcmd_line") | cut -f1 -d' ')
if [[ "$nlines" -eq 1 && "$passcmd_line" =~ $pass_re ]]
then
    passcmd=${BASH_REMATCH[1]}
else
    echo "error: $mbconf: does not contain exactly one PassCmd"
    exit 1
fi

before_pw=$(sed '/PassCmd/,$d' "$mbconf")
pw=$(echo "Pass $($passcmd)")
after_pw=$(sed '1,/PassCmd/d' "$mbconf")

while true
do
    mbsync -c <(echo "$before_pw"; echo "$pw"; echo "$after_pw") -a
    sleep 600
done
